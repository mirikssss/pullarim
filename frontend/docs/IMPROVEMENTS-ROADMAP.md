# Доработки по системе Pullar (не только AI-чат)

Обзор по валидации, дизайну, UX, логике и инфраструктуре.

---

## 1. Валидация

### API (бэкенд)

| Что | Где | Рекомендация |
|-----|-----|--------------|
| Формат ошибок | Все API | Уже есть `{ error: { code, message, fieldErrors? } }`. Держать единообразно. |
| Импорт Payme | `api/import/payme/preview`, `commit` | Ввести Zod-схему для `category_mapping` (например `z.record(z.string(), z.string())`) при приёме JSON-строки; при невалидном JSON возвращать 400 с понятным сообщением. |
| Assistant | `api/assistant/message` | Уже есть `messageBodySchema`. Ок. |
| Export | `api/export`, `api/export/[filename]` | Проверить наличие `exportQuerySchema` и использование в обоих маршрутах. |

### Клиент (формы)

| Что | Где | Рекомендация |
|-----|-----|--------------|
| Извлечение сообщения об ошибке | `lib/api.ts` | Сейчас: `throw new Error(err.error ?? res.statusText)`. API отдаёт `{ error: { code, message } }`, поэтому `err.error` — объект. Нужно: `err.error?.message ?? (typeof err.error === 'string' ? err.error : null) ?? res.statusText`. |
| Показ ошибок по полям | add, expenses (редакт), salary, settings, import | Бэкенд возвращает `fieldErrors`. На формах выводить их под полями (например под Input). |
| Валидация на клиенте | auth, add, salary, settings | Опционально: react-hook-form + @hookform/resolvers + те же (или производные) Zod-схемы; минимум — проверка email/длина пароля на auth, обязательные поля на add. |

---

## 2. Обратная связь (toast)

| Что | Где | Рекомендация |
|-----|-----|--------------|
| Рендер тостера | `app/layout.tsx` или `app/app/layout.tsx` | Сейчас тостер (Sonner/Toaster) нигде не подключён. Добавить `<Toaster />` из `@/components/ui/sonner` в корневой layout. |
| Вызов тостов | add, expenses, salary, settings, quick-add, import | Заменить все `// TODO: toast` на реальные вызовы: при успехе — `toast.success('Расход добавлен')`, при ошибке — `toast.error(message)` (message из ответа API после исправления `lib/api.ts`). |

---

## 3. Дизайн и темы

| Что | Где | Рекомендация |
|-----|-----|--------------|
| Тема (светлая/тёмная) | `app/layout.tsx` | Есть `ThemeProvider` в `components/theme-provider.tsx`, но он не обёрнут вокруг приложения. Обернуть `<body>` в `<ThemeProvider>`, чтобы переключатель темы работал глобально. |
| Бюджет на дашборде | `components/dashboard/spending-summary.tsx` | Сейчас `const budget = 5_000_000` захардкожен. Вынести лимит в настройки: поле в профиле или отдельная сущность (например `user_settings.monthly_budget`), подставлять в компонент. |
| Viewport | `app/layout.tsx` | `userScalable: false` ухудшает доступность. Убрать или заменить на `maximumScale: 5` и разрешить масштаб. |

---

## 4. UX

| Что | Где | Рекомендация |
|-----|-----|--------------|
| Единый UI ошибок | Страницы с SWR | При `error` от SWR показывать баннер/блок «Не удалось загрузить. Повторить» с кнопкой retry (mutate). |
| Подтверждение деструктивных действий | Удаление расхода, режима ЗП, выплаты | Уже есть диалоги подтверждения. Проверить, что везде есть явный «Отмена» и «Удалить». |
| Loading при отправке | add, expenses (save edit), salary, import | Кнопки с Loader2 и disabled уже есть. Ок. |
| Пустые состояния | Список расходов, выплат, режимов | Добавить короткие подсказки «Добавьте первый расход» / «Настройте режим зарплаты» со ссылками на добавление. |

---

## 5. Логика и граничные случаи

| Что | Где | Рекомендация |
|-----|-----|--------------|
| Дубликаты расходов | Добавление расхода | Опционально: при добавлении проверять «похожий» расход (та же дата + мерчант + сумма) и спрашивать «Возможно дубликат. Всё равно добавить?». |
| Импорт Payme | `api/import/payme/commit` | При падении парсинга XLSX возвращать 400 с сообщением «Неверный формат файла» вместо 500. |
| Прогноз зарплаты | `api/salary/forecast`, `lib/salary-forecast.ts` | Логика частично дублируется. По возможности вызывать одну реализацию (lib) из route. |
| Ассистент: невалидный JSON в tool_arguments | `api/assistant/message/route.ts` | Уже есть try/catch с `args = {}`. Можно логировать и при критичных инструментах возвращать пользователю «Ошибка вызова инструмента». |

---

## 6. Доступность (a11y)

| Что | Рекомендация |
|-----|--------------|
| Фокус в модалках | При открытии диалога фокус в первый интерактивный элемент; при закрытии — возврат на кнопку, открывшую диалог. |
| Кнопки и ссылки | Проверить, что у иконок без текста есть `aria-label` (bottom-nav, sidebar, FAB ассистента). |
| Контраст и шрифты | Проверить контраст подсказок и disabled-состояний; не уменьшать только размер шрифта для «обязательных» полей. |

---

## 7. Тесты

| Что | Рекомендация |
|-----|--------------|
| Unit | Добавить Vitest (или Jest). Тестировать: `salaryModesOverlap`, `toDateStr`/даты, форматтеры UZS, Zod-схемы (валидные/невалидные входы). |
| API | Интеграционные тесты на ключевые маршруты: GET/POST expenses, salary/forecast, assistant/message (с моком AI). |
| E2E | По желанию: Playwright/Cypress для сценариев вход → добавление расхода → проверка на дашборде; импорт Payme. |

---

## 8. Прочее

| Что | Где | Рекомендация |
|-----|-----|--------------|
| i18n | Весь проект | Строки захардкожены на русском. Для мультиязычности позже — next-intl или аналог, вынос строк в ключи. |
| dev/delete-all | `api/expenses/dev/delete-all` | Уже защищён `NODE_ENV === "development"`. В проде не экспонировать. |
| Безопасность | API | RLS в Supabase и проверка `getAuthUser()` в маршрутах уже есть. Следить за тем, чтобы все мутирующие эндпоинты требовали авторизацию. |

---

## Приоритизация

**Высокий приоритет (быстро и заметно для пользователя):**

1. Исправить извлечение сообщения об ошибке в `lib/api.ts`.
2. Подключить Toaster в layout и заменить TODO: toast на реальные вызовы.
3. Вынести бюджет из константы в настройки и подставлять в дашборд.

**Средний:**

4. Zod для `category_mapping` при импорте Payme и понятные 400 при ошибке парсинга.
5. Показ `fieldErrors` с API под полями форм (add, edit expense, salary, settings).
6. ThemeProvider в корневом layout.

**Низкий / по возможности:**

7. react-hook-form + Zod на формах; проверка дубликатов расхода; единый баннер ошибки SWR; a11y (фокус, aria-label); unit/API тесты; i18n.
